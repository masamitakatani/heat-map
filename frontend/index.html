<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/typescript.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Heatmap Analytics - APIçµ±åˆãƒ†ã‚¹ãƒˆ</title>
    <style>
      body {
        font-family: 'Arial', sans-serif;
        max-width: 900px;
        margin: 50px auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #4CAF50;
        padding-bottom: 10px;
      }
      h2 {
        color: #555;
        margin-top: 30px;
      }
      .section {
        margin-bottom: 30px;
      }
      button {
        background-color: #4CAF50;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px;
      }
      button:hover {
        background-color: #45a049;
      }
      button.secondary {
        background-color: #2196F3;
      }
      button.secondary:hover {
        background-color: #0b7dda;
      }
      button.danger {
        background-color: #f44336;
      }
      button.danger:hover {
        background-color: #da190b;
      }
      .config-form {
        display: grid;
        gap: 15px;
        margin: 20px 0;
      }
      .form-group {
        display: flex;
        flex-direction: column;
      }
      label {
        font-weight: bold;
        margin-bottom: 5px;
        color: #555;
      }
      input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      .info-box {
        background-color: #e7f3ff;
        border-left: 4px solid #2196F3;
        padding: 15px;
        margin: 15px 0;
      }
      #output {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 4px;
        min-height: 200px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }
      .output-line {
        margin: 5px 0;
        padding: 5px;
        border-bottom: 1px solid #eee;
      }
      .output-success {
        color: #4CAF50;
      }
      .output-error {
        color: #f44336;
      }
      .output-info {
        color: #2196F3;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”¥ Heatmap Analytics - APIçµ±åˆãƒ†ã‚¹ãƒˆ</h1>

      <div class="info-box">
        <strong>ğŸ“Œ ã“ã®ãƒšãƒ¼ã‚¸ã«ã¤ã„ã¦:</strong> APIçµ±åˆã®ãƒ†ã‚¹ãƒˆç”¨ãƒšãƒ¼ã‚¸ã§ã™ã€‚Connected One APIã¨ã®æ¥ç¶šã€Webhooké€ä¿¡ã€TanStack Queryã®å‹•ä½œç¢ºèªãŒã§ãã¾ã™ã€‚
      </div>

      <!-- åˆæœŸåŒ–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="section">
        <h2>1. åˆæœŸåŒ–è¨­å®š</h2>
        <div class="config-form">
          <div class="form-group">
            <label for="apiKey">APIã‚­ãƒ¼</label>
            <input type="text" id="apiKey" placeholder="your-api-key-here" value="test-key-123" />
          </div>
          <div class="form-group">
            <label for="projectId">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID</label>
            <input type="text" id="projectId" placeholder="proj_abc123" value="proj_test_001" />
          </div>
          <div class="form-group">
            <label for="baseUrl">API Base URL</label>
            <input type="text" id="baseUrl" value="https://api.connected-one.com/v1" />
          </div>
        </div>
        <button onclick="initializeHeatmap()">åˆæœŸåŒ–</button>
        <button class="secondary" onclick="checkInitStatus()">åˆæœŸåŒ–çŠ¶æ…‹ã‚’ç¢ºèª</button>
      </div>

      <!-- APIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ -->
      <div class="section">
        <h2>2. APIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testFetchFunnels()">ãƒ•ã‚¡ãƒãƒ«æƒ…å ±ã‚’å–å¾—</button>
        <button onclick="testFetchProjectSettings()">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’å–å¾—</button>
      </div>

      <!-- Webhookãƒ†ã‚¹ãƒˆ -->
      <div class="section">
        <h2>3. Webhooké€ä¿¡ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testSendFunnelCompleted()">ãƒ•ã‚¡ãƒãƒ«å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡</button>
        <button onclick="testSendFunnelDropoff()">ãƒ•ã‚¡ãƒãƒ«é›¢è„±ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡</button>
        <button class="secondary" onclick="testFlushQueue()">Webhookã‚­ãƒ¥ãƒ¼ã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥</button>
      </div>

      <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
      <div class="section">
        <h2>4. ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
        <button class="danger" onclick="clearAllData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
        <button class="secondary" onclick="showLocalStorageData()">LocalStorageã‚’è¡¨ç¤º</button>
      </div>

      <!-- å‡ºåŠ›ã‚¨ãƒªã‚¢ -->
      <div class="section">
        <h2>ğŸ“Š å®Ÿè¡Œçµæœ</h2>
        <div id="output"></div>
        <button class="secondary" onclick="clearOutput()">å‡ºåŠ›ã‚’ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <script type="module">
      import HeatmapAnalytics from './src/main.ts';
      import {
        sendWebhook,
        flushWebhookQueue
      } from './src/api/index.ts';

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
      window.HeatmapAnalytics = HeatmapAnalytics;
      window.HeatmapAPI = {
        sendWebhook,
        flushWebhookQueue
      };

      let tracker = null;

      // å‡ºåŠ›ãƒ˜ãƒ«ãƒ‘ãƒ¼
      window.log = (message, type = 'info') => {
        const output = document.getElementById('output');
        const line = document.createElement('div');
        line.className = `output-line output-${type}`;
        line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        output.appendChild(line);
        output.scrollTop = output.scrollHeight;
        console.log(message);
      };

      window.clearOutput = () => {
        document.getElementById('output').innerHTML = '';
      };

      // 1. åˆæœŸåŒ–
      window.initializeHeatmap = () => {
        const apiKey = document.getElementById('apiKey').value;
        const projectId = document.getElementById('projectId').value;
        const baseUrl = document.getElementById('baseUrl').value;

        if (!apiKey || !projectId) {
          log('ã‚¨ãƒ©ãƒ¼: APIã‚­ãƒ¼ã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
          return;
        }

        try {
          tracker = new HeatmapAnalytics({
            api: { apiKey, projectId, baseUrl },
            debug: true,
            autoStart: false,
          });
          tracker.init();
          log('âœ… åˆæœŸåŒ–æˆåŠŸ', 'success');
        } catch (error) {
          log(`âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        }
      };

      window.checkInitStatus = () => {
        if (tracker) {
          log(`âœ… åˆæœŸåŒ–æ¸ˆã¿ - SessionID: ${tracker.getSessionId()}`, 'success');
          log(`   AnonymousID: ${tracker.getAnonymousId()}`, 'info');
        } else {
          log('âŒ æœªåˆæœŸåŒ–', 'error');
        }
      };

      // 2. APIå‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ
      window.testFetchFunnels = async () => {
        const projectId = document.getElementById('projectId').value;
        if (!projectId) {
          log('ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
          return;
        }

        log('ğŸ“¡ ãƒ•ã‚¡ãƒãƒ«æƒ…å ±ã‚’å–å¾—ä¸­...', 'info');
        try {
          const { fetchFunnels } = await import('./src/api/connectedOne.ts');
          const response = await fetchFunnels(projectId);

          if (response.error) {
            log(`âŒ ã‚¨ãƒ©ãƒ¼: ${response.error.message}`, 'error');
          } else {
            log(`âœ… ãƒ•ã‚¡ãƒãƒ«å–å¾—æˆåŠŸ: ${response.data.length}ä»¶`, 'success');
            log(JSON.stringify(response.data, null, 2), 'info');
          }
        } catch (error) {
          log(`âŒ ä¾‹å¤–: ${error.message}`, 'error');
        }
      };

      window.testFetchProjectSettings = async () => {
        const projectId = document.getElementById('projectId').value;
        if (!projectId) {
          log('ã‚¨ãƒ©ãƒ¼: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
          return;
        }

        log('ğŸ“¡ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’å–å¾—ä¸­...', 'info');
        try {
          const { fetchProjectSettings } = await import('./src/api/connectedOne.ts');
          const response = await fetchProjectSettings(projectId);

          if (response.error) {
            log(`âŒ ã‚¨ãƒ©ãƒ¼: ${response.error.message}`, 'error');
          } else {
            log('âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šå–å¾—æˆåŠŸ', 'success');
            log(JSON.stringify(response.data, null, 2), 'info');
          }
        } catch (error) {
          log(`âŒ ä¾‹å¤–: ${error.message}`, 'error');
        }
      };

      // 3. Webhookãƒ†ã‚¹ãƒˆ
      window.testSendFunnelCompleted = async () => {
        const projectId = document.getElementById('projectId').value;
        if (!tracker) {
          log('ã‚¨ãƒ©ãƒ¼: å…ˆã«åˆæœŸåŒ–ã—ã¦ãã ã•ã„', 'error');
          return;
        }

        const payload = {
          event_type: 'funnel.completed',
          project_id: projectId,
          funnel_id: 'funnel_test_001',
          user: {
            anonymous_id: tracker.getAnonymousId(),
            session_id: tracker.getSessionId(),
          },
          funnel_data: {
            funnel_name: 'ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒãƒ«',
            total_steps: 3,
            completed_steps: [0, 1, 2],
            started_at: new Date(Date.now() - 600000).toISOString(),
            completed_at: new Date().toISOString(),
            duration_seconds: 600,
          },
          device: {
            type: 'desktop',
            viewport_width: window.innerWidth,
            viewport_height: window.innerHeight,
          },
          timestamp: new Date().toISOString(),
        };

        log('ğŸ“¡ ãƒ•ã‚¡ãƒãƒ«å®Œäº†Webhookã‚’é€ä¿¡ä¸­...', 'info');
        try {
          const response = await window.HeatmapAPI.sendWebhook(payload);
          if (response.error) {
            log(`âš ï¸ ${response.error.message}`, 'error');
          } else {
            log('âœ… Webhooké€ä¿¡æˆåŠŸ', 'success');
          }
        } catch (error) {
          log(`âŒ ä¾‹å¤–: ${error.message}`, 'error');
        }
      };

      window.testSendFunnelDropoff = async () => {
        const projectId = document.getElementById('projectId').value;
        if (!tracker) {
          log('ã‚¨ãƒ©ãƒ¼: å…ˆã«åˆæœŸåŒ–ã—ã¦ãã ã•ã„', 'error');
          return;
        }

        const payload = {
          event_type: 'funnel.dropped_off',
          project_id: projectId,
          funnel_id: 'funnel_test_001',
          user: {
            anonymous_id: tracker.getAnonymousId(),
            session_id: tracker.getSessionId(),
          },
          funnel_data: {
            funnel_name: 'ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒãƒ«',
            total_steps: 3,
            completed_steps: [0, 1],
            dropoff_step: 1,
            dropoff_step_name: 'ã‚¹ãƒ†ãƒƒãƒ—2',
            started_at: new Date(Date.now() - 300000).toISOString(),
            dropped_at: new Date().toISOString(),
            duration_seconds: 300,
          },
          device: {
            type: 'desktop',
            viewport_width: window.innerWidth,
            viewport_height: window.innerHeight,
          },
          timestamp: new Date().toISOString(),
        };

        log('ğŸ“¡ ãƒ•ã‚¡ãƒãƒ«é›¢è„±Webhookã‚’é€ä¿¡ä¸­...', 'info');
        try {
          const response = await window.HeatmapAPI.sendWebhook(payload);
          if (response.error) {
            log(`âš ï¸ ${response.error.message}`, 'error');
          } else {
            log('âœ… Webhooké€ä¿¡æˆåŠŸ', 'success');
          }
        } catch (error) {
          log(`âŒ ä¾‹å¤–: ${error.message}`, 'error');
        }
      };

      window.testFlushQueue = async () => {
        log('ğŸ“¡ Webhookã‚­ãƒ¥ãƒ¼ã‚’ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ä¸­...', 'info');
        try {
          await window.HeatmapAPI.flushWebhookQueue();
          log('âœ… ã‚­ãƒ¥ãƒ¼ãƒ•ãƒ©ãƒƒã‚·ãƒ¥å®Œäº†', 'success');
        } catch (error) {
          log(`âŒ ä¾‹å¤–: ${error.message}`, 'error');
        }
      };

      // 4. ãƒ‡ãƒ¼ã‚¿ç®¡ç†
      window.clearAllData = () => {
        if (tracker) {
          tracker.clearData();
          log('âœ… å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        } else {
          log('ã‚¨ãƒ©ãƒ¼: å…ˆã«åˆæœŸåŒ–ã—ã¦ãã ã•ã„', 'error');
        }
      };

      window.showLocalStorageData = () => {
        log('ğŸ“¦ LocalStorageå†…å®¹:', 'info');
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith('heatmap_')) {
            const value = localStorage.getItem(key);
            log(`  ${key}: ${value.substring(0, 100)}...`, 'info');
          }
        }
      };
    </script>
  </body>
</html>
