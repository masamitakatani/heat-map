# ヒートマップ & ファネル解析ツール - 要件定義書

## 1. プロジェクト概要

### 1.1 目的
コネクティッドワンの拡張機能として、LP(ランディングページ)のユーザー行動を可視化し、ファネル分析を可能にするツールを開発する。

### 1.2 背景
- 既存のヒートマップツール(ミエルカ等)は気軽に使えるものが少ない
- ファネル解析とヒートマップを統合したツールが必要
- コネクティッドワンとシームレスに連携できるツールが求められている

### 1.3 ターゲットユーザー/ペルソナ

#### プライマリユーザー
1. **マーケター**
   - 役割: LP改善、CVR最適化担当
   - 課題: ユーザーの離脱ポイントが分からない
   - 期待する成果: データに基づくLP改善、CVR向上

2. **個人起業家**
   - 役割: 自社LPの運営・改善
   - 課題: 高額なツールは導入できない
   - 期待する成果: 低コストでユーザー行動を把握

3. **コネクティッドワンユーザー**
   - 役割: LPビルダーツールの利用者
   - 課題: 作成したLPの効果測定が難しい
   - 期待する成果: LP作成と分析をシームレスに実行

### 1.4 参考ツール
- [Howuku](https://howuku.com/) - ヒートマップ、Google Analytics連携、ファネル解析

### 1.5 納品形態
- コネクティッドワン拡張機能として納品
- **制約**: 開発者に維持費がかかる設計は不可(サーバーレス必須)

---

## 2. システム構成

### 2.1 基本構成
- **方式**: JavaScriptライブラリとして提供
- **導入方法**: ユーザーが解析対象のLPに`<script>`タグで埋め込み
- **管理画面**: なし(LP上で直接可視化)
- **ホスティング**: 静的ホスティング(CDN経由で配信)

### 2.2 データ保存
- **保存場所**: ブラウザのLocalStorage(完全サーバーレス)
- **保存期間**: 永続化(ユーザーごとにテスト期間が異なるため)
- **容量制限**: 5MB(LocalStorageの制限)
- **容量超過時の対応**:
  - 古いデータを自動削除(FIFO方式)
  - ユーザーに警告を表示
  - 手動クリア機能も提供
- **データクリア**: ユーザーが手動でクリア可能
- **バックエンドDB**: 不使用(維持費ゼロ制約)

### 2.3 コネクティッドワン連携
- **連携方法**: API + Webhook
- **連携内容**:
  - ファネル情報の取得
  - ユーザー行動データの送信

---

## 3. 主要機能

### 3.1 ヒートマップ機能

#### 3.1.1 クリックヒートマップ
- ユーザーのクリック位置を記録
- クリック頻度を色の濃淡で可視化(赤=高頻度、青=低頻度)
- クリック可能要素(ボタン、リンク等)のクリック率表示

#### 3.1.2 スクロールヒートマップ
- ページのスクロール深度を記録
- ユーザーが離脱したポイントを可視化
- 平均到達率をパーセンテージで表示

#### 3.1.3 マウスムーブメントヒートマップ
- マウスカーソルの移動軌跡を記録
- ユーザーの注目エリアを可視化
- ホバー時間の長いエリアを強調表示

### 3.2 ファネル解析機能

#### 3.2.1 マルチステップ解析
- 複数ページにまたがるファネルを定義
- 対象ページ例:
  - オプトインページ
  - ECサイト(商品ページ)
  - サンクスページ
  - セールスレター
  - その他任意のページ

#### 3.2.2 遷移率・離脱率の計測
- ステップ間の遷移率を計算
- 各ステップの離脱率を可視化
- ボトルネックとなるページを特定

#### 3.2.3 クロスドメイン対応
- 異なるドメイン間の遷移を追跡
- 外部ツールを跨いだ計測に対応
- URLベースでステップを定義

### 3.3 表示制御機能

#### 3.3.1 ON/OFF切り替え
- ヒートマップ表示の切り替えボタン
- 表示状態をLocalStorageに保存
- ページリロード後も状態を維持

#### 3.3.2 表示モード切り替え
- クリックヒートマップ表示
- スクロールヒートマップ表示
- マウスムーブメント表示
- ファネル解析ダッシュボード表示

#### 3.3.3 データリセット機能
- 記録したデータを手動でクリア
- 確認ダイアログ表示(誤操作防止)

### 3.4 UI/UX要件

#### 3.4.1 オーバーレイUI配置
- **配置**: 画面上に浮遊表示
- **移動**: ドラッグ&ドロップで自由に移動可能
- **初期位置**: 画面右下
- **状態保存**: 移動後の位置をLocalStorageに保存

#### 3.4.2 ヒートマップ色スキーム
- **カラーグラデーション**:
  - 赤(#FF0000) = 高頻度(100%)
  - 黄(#FFFF00) = 中頻度(50%)
  - 青(#0000FF) = 低頻度(0%)
- **透明度**: 0.3〜0.8の範囲で頻度に応じて変化

#### 3.4.3 レスポンシブデザイン
- **PC対応**: 必須
- **タブレット対応**: 必須
- **スマートフォン対応**: 必須
- **最小対応画面幅**: 320px
- **ブレイクポイント**:
  - モバイル: 〜767px
  - タブレット: 768px〜1023px
  - デスクトップ: 1024px〜

---

## 4. 技術要件

### 4.1 フロントエンド
- **言語**: TypeScript
- **ライブラリサイズ**: 軽量化を最優先(目標: 50KB以下)
- **ブラウザ対応**:
  - Chrome(最新版)
  - Firefox(最新版)
  - Safari(最新版)
  - Edge(最新版)

### 4.2 データ保存
- **Storage**: LocalStorage
- **データ形式**: JSON
- **容量制限**: 5MB以内に収める(LocalStorageの制限考慮)

### 4.3 パフォーマンス
- **ページ読み込み速度**: ツール導入によるパフォーマンス低下を最小限に
- **非同期処理**: データ記録は非同期で実行
- **サンプリング**: 大量データは間引いて保存

### 4.4 セキュリティ
- **個人情報**: クリック座標のみ記録(個人を特定できる情報は記録しない)
- **CORS対応**: クロスドメイン通信を安全に実行
- **XSS対策**: ユーザー入力のサニタイズ

### 4.5 エラーハンドリング

#### 4.5.1 LocalStorage容量超過
- **検知**: 書き込み前に容量チェック
- **対応**:
  1. 古いデータを自動削除(FIFO方式)
  2. 警告トーストメッセージを表示
  3. 手動クリア用のボタンを表示
- **ログ**: コンソールに警告メッセージ出力

#### 4.5.2 スクリプト読み込み失敗
- **対応**: エラー発生時もLPは正常に動作
- **フォールバック**: ツール機能のみ無効化
- **通知**: コンソールにエラーログ出力

#### 4.5.3 データ破損
- **検知**: JSONパースエラー時
- **対応**: 破損データを削除して初期化
- **通知**: ユーザーに警告メッセージ表示

---

## 5. コネクティッドワン連携仕様

### 5.1 API連携
- **認証**: コネクティッドワンのAPIキーを使用
- **エンドポイント**:
  - ファネル情報取得API
  - ユーザー行動データ送信API

### 5.2 Webhook連携
- **トリガー**:
  - ファネルステップ完了時
  - 離脱発生時
- **送信データ**:
  - ユーザーID(匿名化)
  - ページURL
  - アクション(クリック、スクロール、離脱等)
  - タイムスタンプ

---

## 6. 非機能要件

### 6.1 可用性
- **稼働率**: 99.9%以上(CDN経由配信)
- **障害対応**: スクリプト読み込み失敗時も元のLPは正常動作

### 6.2 保守性
- **コードの可読性**: TypeScriptで型安全に実装
- **ドキュメント**: APIドキュメント、導入ガイドを整備

### 6.3 拡張性
- **プラグイン機構**: 将来的に機能追加しやすい設計
- **カスタマイズ**: 色、表示位置等をオプションで変更可能

### 6.4 アクセシビリティ要件
- **キーボード操作**: 対応不要
- **スクリーンリーダー**: 対応不要
- **理由**: 主に分析ツールとしての利用であり、一般ユーザー向け機能ではないため

---

## 7. 制約事項

### 7.1 維持費ゼロ設計
- サーバーレス構成必須
- 月額課金サービスの利用禁止
- 静的ホスティング(Netlify、Vercel等の無料枠)のみ使用

### 7.2 データ保存の制限
- **サーバー側DB**: 完全不使用
- **LocalStorageのみ**: 容量制限5MB
- **データ永続化**: クライアント側のみ
- **バックエンドAPI**: コネクティッドワン連携のみ(データ保存なし)

### 7.3 計測対象
- コネクティッドワンで作成したLP
- 外部サイト(ユーザーがスクリプトを埋め込める場合)

---

## 8. 成功指標(KPI)

### 8.1 技術的指標
- スクリプトサイズ: 50KB以下(gzip圧縮後)
- ページ読み込み速度への影響: 100ms以下
- エラー発生率: 1%以下
- LocalStorage使用量: 3MB以下(5MBの60%)

### 8.2 ユーザー体験指標
- 導入の簡単さ: コピー&ペーストのみで完了
- ヒートマップ表示速度: 1秒以内
- データ記録の正確性: 99%以上
- オーバーレイUIの応答速度: 100ms以内

### 8.3 MVP(最小機能セット)定義
Phase 1リリースに含む必須機能:
- [x] クリックヒートマップ
- [x] スクロールヒートマップ
- [x] マウスムーブメントヒートマップ
- [x] ファネル解析
- [x] コネクティッドワン連携
- [x] オーバーレイUI(ドラッグ移動可能)
- [x] レスポンシブデザイン(PC/タブレット/スマホ対応)

---

## 9. 今後の拡張案

### 9.1 Phase 2以降の候補機能
- Google Analytics連携
- A/Bテスト機能
- セッション録画(リプレイ機能)
- リアルタイムダッシュボード
- Slack/Emailによるアラート通知

### 9.2 有料プラン検討
- データエクスポート機能
- カスタムレポート作成
- チーム共有機能

---

## 10. テスト要件

### 10.1 単体テスト
- **対象**: 全ての関数・モジュール
- **カバレッジ目標**: 80%以上
- **ツール**: Jest + Testing Library

### 10.2 E2Eテスト
- **対象**: 主要ユーザーフロー
- **シナリオ**:
  1. スクリプト読み込み → ヒートマップ表示
  2. クリック記録 → データ保存 → ヒートマップ可視化
  3. ファネル設定 → 遷移率計測
- **ツール**: Playwright または Cypress

### 10.3 ブラウザ互換性テスト
- **対象ブラウザ**:
  - Chrome(最新版・1つ前のバージョン)
  - Firefox(最新版)
  - Safari(最新版)
  - Edge(最新版)
- **デバイス**:
  - デスクトップ(Windows/Mac)
  - タブレット(iPad)
  - スマートフォン(iPhone/Android)

### 10.4 パフォーマンステスト
- **測定項目**:
  - スクリプト読み込み時間
  - ヒートマップ描画速度
  - メモリ使用量
  - LocalStorage書き込み速度
- **ツール**: Lighthouse、Chrome DevTools

---

## 11. 開発スケジュール(参考)

| Phase | 内容 | 期間(想定) |
|-------|------|-----------|
| Phase 1 | 要件定義・ヒアリング | 完了 |
| Phase 2 | 技術選定 | 1日 |
| Phase 3 | フロントエンド基盤構築 | 1日 |
| Phase 4 | ヒートマップ機能実装 | 3日 |
| Phase 5 | ファネル解析機能実装 | 2日 |
| Phase 6 | コネクティッドワン連携実装 | 2日 |
| Phase 7 | UI/UX実装(レスポンシブ対応) | 2日 |
| Phase 8 | テスト | 2日 |
| Phase 9 | ドキュメント作成 | 1日 |
| Phase 10 | デプロイ準備 | 1日 |

---

## 12. 補足資料

### 12.1 用語定義
- **LP(ランディングページ)**: ユーザーが最初に訪れるページ
- **ファネル**: 複数ステップを経て目標(コンバージョン)に到達するまでの流れ
- **ヒートマップ**: ユーザー行動を色の濃淡で可視化したもの
- **離脱率**: あるステップで離脱したユーザーの割合

### 12.2 参考リンク
- [コネクティッドワン公式サイト](https://connected-one.com/)
- [Howuku(参考ツール)](https://howuku.com/)

### 12.3 ユーザーストーリー例

#### ストーリー1: マーケターのLP改善
> 「マーケターとして、LPのCVRが低い原因を特定したい。ヒートマップを見ることで、ユーザーがどこで離脱しているかを把握し、改善施策を立案できる。」

#### ストーリー2: 個人起業家のコスト削減
> 「個人起業家として、高額なツールは使えない。無料で使えるヒートマップツールがあれば、自分のLPを改善できる。」

#### ストーリー3: コネクティッドワンユーザーの効果測定
> 「コネクティッドワンでLPを作成したが、どれくらい効果があるか分からない。ヒートマップとファネル解析を使って、LP改善のPDCAを回したい。」

---

**作成日**: 2025年11月1日
**最終更新日**: 2025年11月2日
**作成者**: AIエンジニア
**バージョン**: 2.0
**変更履歴**:
- v1.0 (2025-11-01): 初版作成
- v2.0 (2025-11-02): ユーザーストーリー、UI/UX要件、エラーハンドリング、テスト要件を追加。データ保存方針を明確化(LocalStorageのみに統一)
