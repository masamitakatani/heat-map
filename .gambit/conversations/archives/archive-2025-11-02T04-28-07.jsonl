{"role":"assistant","content":"# API統合担当者への引き継ぎ指示書\n\n**作成日**: 2025年11月2日  \n**前工程**: Phase 4-6（フロントエンドライブラリ実装）完了  \n**次工程**: Phase 7（API統合）\n\n---\n\n## 📦 完了した成果物\n\n### JavaScriptライブラリ（`/packages/frontend/`）\n- **ビルド成果物**: `dist/heatmap-analytics.umd.js` (9.99KB gzip)\n- **ステータス**: ✅ プロダクションレディ\n- **実装機能**:\n  - ヒートマップ（クリック、スクロール、マウス移動）\n  - ファネル分析\n  - UI/UX（トースト、ローディング、レスポンシブ）\n\n### ドキュメント\n- `/docs/PHASE6_UI_UX_COMPLETION.md` - Phase 6完了レポート\n- `/packages/frontend/README.md` - ライブラリの使用方法\n\n---\n\n## 🔗 API統合が必要な箇所\n\n### 1. Webhook送信機能（実装済み・未接続）\n\n**ファイル**: `/packages/frontend/src/api/webhook.ts`\n\n```typescript\nexport class WebhookClient {\n  constructor(config: APIConfig) {\n    this.baseUrl = config.baseUrl;\n    this.apiKey = config.apiKey;\n  }\n  \n  async send(payload: WebhookPayload): Promise<boolean>\n}\n```\n\n**現状**: \n- ✅ Webhookクライアントクラス実装済み\n- ✅ オフラインキュー機能実装済み\n- ✅ リトライロジック実装済み\n- ❌ バックエンドエンドポイント未接続\n\n**必要な作業**:\n1. バックエンドAPIエンドポイントの確認（`/backend/app/`参照）\n2. main.tsでWebhookClientを有効化\n3. イベント送信タイミングの設定\n4. エラーハンドリングの追加\n\n**接続箇所**（`/packages/frontend/src/main.ts`）:\n```typescript\n// 現在コメントアウト状態\n// @ts-ignore - 将来の拡張用に保持\nprivate webhookClient: WebhookClient | null = null;\n\n// 有効化する場合\nif (config.api?.baseUrl && config.api?.apiKey) {\n  this.webhookClient = new WebhookClient(config.api);\n}\n```\n\n---\n\n### 2. ファネル情報取得（未実装）\n\n**現状**: LocalStorageにデフォルトファネルを保存\n\n**ファイル**: `/packages/frontend/src/funnel/funnelManager.ts`\n\n```typescript\nexport function createDefaultFunnels(): FunnelDefinition[] {\n  // ハードコードされたデフォルトファネル\n}\n```\n\n**必要な作業**:\n1. バックエンドからファネル定義を取得するAPIクライアント実装\n2. `getAllFunnels()`をAPI呼び出しに変更\n3. LocalStorageとの併用（オフライン対応）\n\n**API仕様（想定）**:\n```typescript\nGET /api/funnels\nResponse: {\n  funnels: FunnelDefinition[]\n}\n```\n\n---\n\n### 3. データ同期機能（未実装）\n\n**必要な機能**:\n- LocalStorageのデータをバックエンドに定期送信\n- バックエンドからの統計データ取得\n\n**実装推奨箇所**: \n- 新規ファイル: `/packages/frontend/src/api/sync.ts`\n\n**必要なAPI**:\n```typescript\n// イベントデータ送信\nPOST /api/events/batch\nRequest: {\n  clicks: ClickEvent[],\n  scrolls: ScrollEvent[],\n  mouseMoves: MouseMoveEvent[]\n}\n\n// 統計データ取得\nGET /api/analytics/funnel/{funnelId}\nResponse: FunnelStats\n```\n\n---\n\n## 🏗️ バックエンド構成の確認\n\n### ディレクトリ\n- `/backend/` - Python/FastAPI実装\n- `/backend/app/` - アプリケーションコード\n- `/backend/alembic/` - マイグレーション\n\n### 確認すべきファイル\n```bash\n# APIエンドポイント一覧\n/backend/app/api/\n/backend/app/api/routes/\n\n# データモデル\n/backend/app/models/\n\n# 環境変数\n/backend/.env.local\n/backend/.env.example\n```\n\n---\n\n## 🔧 統合手順（推奨）\n\n### Step 1: バックエンドAPI仕様の確認\n```bash\ncd /Users/masamitakatani/Desktop/heat-map/backend\ncat API_IMPLEMENTATION.md\ncat README.md\n```\n\n**確認項目**:\n- [ ] エンドポイントURL\n- [ ] 認証方式（APIキー、JWT等）\n- [ ] リクエスト/レスポンス形式\n- [ ] CORS設定\n\n### Step 2: フロントエンドにAPI設定追加\n\n**ファイル**: `/packages/frontend/src/types/index.ts`\n\n現在の設定:\n```typescript\nexport interface APIConfig {\n  baseUrl: string;\n  apiKey: string;\n}\n```\n\n必要に応じて拡張:\n```typescript\nexport interface APIConfig {\n  baseUrl: string;\n  apiKey?: string;\n  authToken?: string;\n  timeout?: number;\n}\n```\n\n### Step 3: Webhookの有効化\n\n**ファイル**: `/packages/frontend/src/main.ts`\n\n```typescript\n// 78-81行目を修正\nif (config.api?.baseUrl && config.api?.apiKey) {\n  this.webhookClient = new WebhookClient(config.api);\n  \n  // イベント送信を有効化\n  this.setupWebhookSync();\n}\n\nprivate setupWebhookSync(): void {\n  // 定期送信ロジック\n  setInterval(() => {\n    const data = loadData();\n    if (data && this.webhookClient) {\n      this.webhookClient.send({\n        type: 'analytics',\n        data: {\n          clicks: data.pendingEvents.clicks,\n          scrolls: data.pendingEvents.scrolls,\n          mouseMoves: data.pendingEvents.mouseMoves,\n        },\n      });\n    }\n  }, 60000); // 1分ごと\n}\n```\n\n### Step 4: エラーハンドリングの追加\n\n```typescript\nimport { showToast } from './ui/toast';\n\ntry {\n  await this.webhookClient.send(payload);\n  showToast({\n    type: 'success',\n    message: 'データを送信しました',\n    duration: 2000,\n  });\n} catch (error) {\n  showToast({\n    type: 'error',\n    message: 'データ送信に失敗しました',\n  });\n  console.error('[Heatmap] Webhook送信エラー', error);\n}\n```\n\n### Step 5: ビルド＆テスト\n\n```bash\ncd /Users/masamitakatani/Desktop/heat-map/packages/frontend\nnpm run build\nnpm run preview\n```\n\n---\n\n## 🧪 テスト項目\n\n### API接続テスト\n- [ ] バックエンドサーバーが起動している\n- [ ] CORS設定が正しい\n- [ ] APIキーが正しく設定されている\n- [ ] Webhookが正常に送信される\n- [ ] オフライン時にキューイングされる\n- [ ] オンライン復帰時に再送される\n\n### データ整合性テスト\n- [ ] LocalStorageとバックエンドのデータが一致\n- [ ] ファネル定義が正しく取得できる\n- [ ] 統計データが正しく表示される\n\n---\n\n## 📝 環境変数設定\n\n### フロントエンド（デモページ用）\n**ファイル**: `/frontend/.env.local`\n\n```bash\nVITE_API_BASE_URL=http://localhost:8000\nVITE_API_KEY=your-api-key-here\n```\n\n### 使用例（デモページ）\n```typescript\nconst heatmap = new HeatmapAnalytics({\n  api: {\n    baseUrl: import.meta.env.VITE_API_BASE_URL,\n    apiKey: import.meta.env.VITE_API_KEY,\n  },\n  debug: true,\n});\n```\n\n---\n\n## 🚨 注意事項\n\n### 1. LocalStorage優先設計\n- バックエンドはあくまで**補助**\n- LocalStorageが主要データストア\n- API障害時もライブラリは動作し続ける\n\n### 2. パフォーマンス\n- イベント送信は**バッチ処理**推奨\n- リアルタイム送信は避ける（パフォーマンス低下）\n- 送信間隔: 30秒〜1分程度\n\n### 3. セキュリティ\n- APIキーはハードコード禁止\n- HTTPS通信必須（本番環境）\n- CORS設定を適切に行う\n\n### 4. エラーリカバリ\n- ネットワークエラー時はリトライ\n- 最大リトライ回数を設定（現在3回）\n- 失敗したデータはLocalStorageに保持\n\n---\n\n## 📚 参考ドキュメント\n\n### フロントエンド\n- `/packages/frontend/README.md` - ライブラリAPI仕様\n- `/packages/frontend/src/api/webhook.ts` - Webhook実装\n- `/docs/PHASE6_UI_UX_COMPLETION.md` - Phase 6完了レポート\n\n### バックエンド\n- `/backend/README.md` - バックエンド概要\n- `/backend/API_IMPLEMENTATION.md` - API実装詳細\n- `/backend/SETUP.md` - セットアップガイド\n\n### 設計書\n- `/docs/requirements/requirements.md` - 要件定義\n- `/docs/API_SPEC.md` - API仕様書（要確認）\n- `/docs/DATABASE_SCHEMA.md` - DB設計（要確認）\n\n---\n\n## ✅ チェックリスト（API統合担当者向け）\n\n### 準備\n- [ ] バックエンドドキュメントを読む\n- [ ] バックエンドをローカルで起動\n- [ ] APIエンドポイント一覧を確認\n- [ ] データベーススキーマを確認\n\n### 実装\n- [ ] フロントエンドでWebhookClientを有効化\n- [ ] イベント送信ロジックを実装\n- [ ] ファネル取得APIを実装\n- [ ] エラーハンドリングを追加\n- [ ] トースト通知を統合\n\n### テスト\n- [ ] ローカル環境で動作確認\n- [ ] ネットワークエラーシミュレーション\n- [ ] オフライン→オンライン復帰テスト\n- [ ] データ整合性テスト\n\n### ドキュメント\n- [ ] API統合完了レポート作成\n- [ ] 使用方法をREADMEに追記\n- [ ] 環境変数設定をドキュメント化\n\n---\n\n## 🎯 成功基準\n\n### 必須\n- [ ] LocalStorageのデータがバックエンドに送信される\n- [ ] バックエンドからファネル定義を取得できる\n- [ ] APIエラー時もライブラリが動作する\n- [ ] ユーザーに適切なフィードバック（トースト）\n\n### 推奨\n- [ ] オフライン時のキューイング動作確認\n- [ ] リトライロジックが正常動作\n- [ ] パフォーマンス劣化なし（<100ms追加レイテンシ）\n\n---\n\n## 📞 引き継ぎ連絡事項\n\n**フロントエンド実装者より**:\n- Phase 4-6のフロントエンド実装は完了\n- ライブラリは単独で動作可能（LocalStorage使用）\n- API統合はオプション機能として設計済み\n- 質問があれば `/packages/frontend/src/` のコードを参照\n\n**次の担当者へ**:\n- バックエンドとの統合を進めてください\n- フロントエンドコードの大幅な変更は不要\n- main.tsの設定変更のみで統合可能\n- テストは `/frontend/` のデモページで実施可能\n\n---\n\n以上で引き継ぎ完了です。API統合頑張ってください！ 🚀\n","timestamp":"2025-11-02T03:55:58.178Z","tokens":3190}
